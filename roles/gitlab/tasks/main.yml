- block: Gitlab - shell install
  - include: "{{ansible_os_family}}.yml"

  # configure gitlab

  # set soft link
  - name: set soft link
    shell: |
      ln -sf /opt/gitlab  /data/wwwroot
      ln -sf /etc/gitlab/gitlab.rb /data/config
  # display version and service state of components
  - name: Get GitLab version
    shell: sudo sh -c "cat /opt/gitlab/version-manifest.txt | grep gitlab-{{gitlab_distribution}} 1>> /data/logs/install_version.txt"

  - name: Check GitLab Service
    shell: gitlab-ctl status  | grep gitlab-workhorse
    register: check_gitlab_service
    notify: check_gitlab_service
  when: gitlab_installmethod == "Shell"

- block: Gitlab - Docker install
  - name: Creates gitlab dock directory
    file:
      path: "{{item}}"
      state: directory
      recurse: yes
    loop:
      - /data/wwwroot/gitlab
      - /data/wwwroot/gitlab/config
      - /data/wwwroot/gitlab/logs
      - /data/wwwroot/gitlab/data

  - name: Copy docker-compose
    template:
      src:  docker-compose.yml
      dest: /data/wwwroot/gitlab/docker-compose.yml

  - name: Run docker-compose
    shell: |
      docker pull gitlab/gitlab-{{gitlab_distribution}}:{{gitlab_docker_version}}
      docker-compose up -d
    args:
      chdir: /data/wwwroot/gitlab
  when: gitlab_installmethod == "Docker"
